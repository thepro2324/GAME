<!DOCTYPE html>
<html>
<head>
    <title>Professional Character Editor</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; }
        #instructions {
            position: absolute; top: 10px; left: 10px;
            color: white; background: rgba(0,0,0,0.8); padding: 15px;
            font-family: sans-serif; border-radius: 8px; pointer-events: none;
        }
        b { color: #ff4444; }
    </style>
</head>
<body>

    <div id="instructions">
        <h3>Character Editor Mode</h3>
        * <b>לחץ על איבר</b> (יד/רגל) כדי לבחור אותו.<br>
        * <b>גרור את החיצים</b> כדי לסובב את האיבר.<br>
        * השתמש בגלגלת העכבר כדי להתקרב/להתרחק.
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        // הגדרות בסיסיות
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // תאורה
        scene.add(new THREE.AmbientLight(0xffffff, 2));
        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(5, 10, 7);
        scene.add(light);

        // בקרת מצלמה (סיבוב מסביב לדמות)
        const orbit = new OrbitControls(camera, renderer.domElement);

        // בקרת שינוי (החצים שמופיעים על האיבר)
        const transform = new TransformControls(camera, renderer.domElement);
        transform.setMode('rotate'); // אנחנו רוצים לסובב איברים, לא להזיז אותם מהמקום
        scene.add(transform);

        // מניעת התנגשות בין המצלמה לחצי הגרירה
        transform.addEventListener('dragging-changed', (event) => {
            orbit.enabled = !event.value;
        });

        const loader = new GLTFLoader();
        let player;
        const selectableBones = [];

        // טעינת הדמות
        loader.load('./models/indian_man_in_suit%20(1).glb', (gltf) => {
            player = gltf.scene;
            player.scale.set(1.2, 1.2, 1.2);
            player.position.set(0, -3.5, 0);
            scene.add(player);

            player.traverse(node => {
                if (node.isBone) {
                    // מוסיפים ייצוג ויזואלי קטן לעצם כדי שיהיה אפשר ללחוץ עליה
                    const helperGeom = new THREE.SphereGeometry(0.1);
                    const helperMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0 });
                    const helper = new THREE.Mesh(helperGeom, helperMat);
                    node.add(helper);
                    selectableBones.push(helper);
                }
            });
        });

        // זיהוי לחיצה על איבר (Raycasting)
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousedown', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(selectableBones);

            if (intersects.length > 0) {
                const selectedBone = intersects[0].object.parent;
                transform.attach(selectedBone);
            }
        });

        // התאמה לשינוי גודל חלון
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>

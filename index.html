<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

    // הגדרות ודיבאג
    const debug = (msg) => {
        const el = document.getElementById('debug-log');
        el.innerHTML += `<br>> ${msg}`;
        console.log(msg);
    };

    const CONFIG = {
        player: './models/indian_man_in_suit%20(1).glb',
        anim: './models/Firing Rifle(2).fbx',
        speed: 0.12
    };

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.5, 8);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 2.5));
    const sun = new THREE.DirectionalLight(0xffffff, 1.5);
    sun.position.set(5, 10, 5);
    scene.add(sun);

    let mixer, player, clock = new THREE.Clock(), keys = {};

    const gltfLoader = new GLTFLoader();
    const fbxLoader = new FBXLoader();

    // טעינת הדמות
    gltfLoader.load(CONFIG.player, (gltf) => {
        player = gltf.scene;
        player.scale.set(1.2, 1.2, 1.2);
        player.position.set(0, -3.5, 0);
        scene.add(player);
        debug("Player GLB Loaded.");

        // מיפוי עצמות המודל
        const modelBones = [];
        player.traverse(n => { if(n.isBone) modelBones.push(n.name); });
        debug(`Model has ${modelBones.length} bones.`);

        mixer = new THREE.AnimationMixer(player);

        // טעינת האנימציה
        fbxLoader.load(CONFIG.anim, (animObj) => {
            const clip = animObj.animations[0];
            debug("FBX Anim Loaded.");

            // שיטת הקישור הכפוי - Forced Retargeting
            clip.tracks.forEach(track => {
                // מנקה את השם מה-FBX
                let rawName = track.name.split('.')[0]
                    .replace('mixamorig_', '')
                    .replace('mixamorig:', '')
                    .replace(/.*\[(.*?)\]/, '$1'); // מוציא מהסוגריים []

                // מחפש עצם במודל שמכילה את השם הזה
                const targetBone = modelBones.find(b => b.toLowerCase().includes(rawName.toLowerCase()) || rawName.toLowerCase().includes(b.toLowerCase()));

                if (targetBone) {
                    const property = track.name.split('.')[1]; // position/quaternion
                    track.name = `${targetBone}.${property}`;
                }
            });

            const action = mixer.clipAction(clip);
            action.play();
            debug("Forced Linking Complete.");
        });
    });

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if (mixer) mixer.update(delta);
        if (player) {
            if (keys['KeyD'] || keys['ArrowRight']) { player.position.x += CONFIG.speed; player.rotation.y = Math.PI / 2; }
            if (keys['KeyA'] || keys['ArrowLeft']) { player.position.x -= CONFIG.speed; player.rotation.y = -Math.PI / 2; }
            camera.position.x = player.position.x;
            camera.lookAt(player.position.x, player.position.y + 1.8, 0);
        }
        renderer.render(scene, camera);
    }
    animate();
</script>

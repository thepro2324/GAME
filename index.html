<!DOCTYPE html>
<html>
<head>
    <title>Character Animator - Full Limb Control</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; }
        #ui {
            position: absolute; top: 10px; left: 10px;
            color: white; background: rgba(0,0,0,0.85); padding: 20px;
            font-family: sans-serif; border-radius: 12px; pointer-events: none;
            border: 1px solid #444;
        }
        .key { color: #58a6ff; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui">
        <h3 style="margin-top:0">עורך אנימציה מקצועי</h3>
        1. לחץ על הכתף או הירך כדי לבחור <br>
        2. השתמש בטבעות כדי לסובב את <b style="color:#ff4444">כל האיבר</b> <br>
        3. <span class="key">קליק ימין:</span> סיבוב מצלמה <br>
        4. <span class="key">גלגלת:</span> זום
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1, 6);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // תאורה חזקה
        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // פקדים
        const orbit = new OrbitControls(camera, renderer.domElement);
        const transform = new TransformControls(camera, renderer.domElement);
        transform.setMode('rotate'); 
        transform.setSize(0.8); // גודל הגיזמו
        scene.add(transform);

        transform.addEventListener('dragging-changed', (e) => orbit.enabled = !e.value);

        const loader = new GLTFLoader();
        let player, weapon;
        const targetBones = []; // רשימת עצמות שניתן ללחוץ עליהן

        loader.load('./models/indian_man_in_suit%20(1).glb', (gltf) => {
            player = gltf.scene;
            player.position.y = -2;
            scene.add(player);

            player.traverse(node => {
                if (node.isBone) {
                    const name = node.name.toLowerCase();
                    
                    // אנחנו בוחרים רק את "עצמות השורש" של האיברים
                    const isMainLimb = name.includes('arm') && !name.includes('forearm') && !name.includes('hand') ||
                                     name.includes('upleg') || name.includes('thigh');

                    if (isMainLimb) {
                        // יצירת "תיבת לחיצה" שקופה סביב הכתף/ירך
                        const geo = new THREE.SphereGeometry(0.2);
                        const mat = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.1 });
                        const hitBox = new THREE.Mesh(geo, mat);
                        node.add(hitBox);
                        targetBones.push(hitBox);
                    }
                    
                    // הצמדת הנשק ליד ימין אם היא נמצאה
                    if (name.includes('hand') && name.includes('r')) {
                        loader.load('./models/m4_carbine_rifle.glb', (wGltf) => {
                            weapon = wGltf.scene;
                            weapon.scale.set(0.6, 0.6, 0.6);
                            weapon.rotation.y = Math.PI / 2;
                            node.add(weapon);
                        });
                    }
                }
            });
        });

        // זיהוי לחיצה
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousedown', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(targetBones);

            if (intersects.length > 0) {
                // מחברים את הגיזמו לעצם האמיתית (ההורה של ה-HitBox)
                transform.attach(intersects[0].object.parent);
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
